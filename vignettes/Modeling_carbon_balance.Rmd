---
title: "Modeling_carbon_balance"
author: "Joseph R. Stinziano"
date: "07/01/2020"
output: html_document
---

```{r}
library(arrhenius.comparison)
library(dplyr)
```

```{r}
#Data below is from Stinziano & Way, 2017
#Week 1 biomass was 2.49 g
#Week 12 biomass was 12.68 g
#Stem biomass is 0.199 * total
#RMR was 0.2 * total at week 1, and 0.4 * total at week 12
#LMA was 100 g/m at week 1, 200 g/m at week 12
leaf_area_1 <- 2.49 * (1 - 0.399) / 100
leaf_area_12 <- 12.68 * (1 - 0.599) / 200
stem_mass_1 <- 2.49 * 0.199
stem_mass_12 <- 12.68 * 0.199
root_mass_1 <- 2.49 * 0.2
root_mass_12 <- 12.68 * 0.4

```
Basically need to run week 1 and week 2 code for environmental data and compile
Note that the output will include a sum across all the environmental data in the
input file. We will need to add descriptors for each day and then sum by day. As
long as DOY is specified in the environment data, we will be able to do this
easily since calculate_photo binds the environmental data to the physiology data.

#Week 1 modeling - low root/leaf ratio
```{r}
data_env <- read.csv(system.file("extdata", "data_test.csv", 
                             package = "arrhenius.comparison"),
                 stringsAsFactors = FALSE)
pars_v <- read.csv(system.file("extdata", "fits_v.csv", 
                             package = "arrhenius.comparison"),
                 stringsAsFactors = FALSE)
pars_j <- read.csv(system.file("extdata", "fits_j.csv", 
                             package = "arrhenius.comparison"),
                 stringsAsFactors = FALSE)
data_phys <- list(NULL)
#Basically, we need a solid set of respiration data
data_r <- calculate_r(data = data_env,
                      leaf_Q10_day = 2.015, #Atkin & Tjoelker 2003, 25C acclimated
                      leaf_Q10_night = 2.015,
                      root_Q10 = 2.015,
                      shoot_Q10 = 2.015,
                      leaf_k25_day = 2.78 * 0.7, #Assumption from Stinziano et al. 2019
                      leaf_k25_night = 2.78, #Resp from control in Stinziano & Way 2017
                      root_k25 = 0.0095,#Weger and Guy 1991
                      shoot_k25 = 0.0095,#Assume stem and root respiration rates are similar
                      leaf_area = leaf_area_1,
                      root_mass = root_mass_1,
                      shoot_mass = stem_mass_1)
data_r <- data_r[, 1:7] #remove temperature column - poses issue later
for(i in 1:nrow(pars_v)){
data_p <- calculate_p(G25 = 42.75, #Bernacchi et al. 2001
                      G_Ea = 37.830, #Bernacchi et al. 2001
                      Km25 = 718.40, #Bernacchi et al. 2001
                      Km_Ea = 65.50828, #Bernacchi et al. 2001
                      Temp = data_env$Temp,
                      Vcmax25_m = pars_v$k25_o[i],
                      Vcmax_dS_m = pars_v$dS_o[i],
                      Vcmax_Hd_m = pars_v$Hd_o[i],
                      Vcmax_Ea_m = pars_v$Ea_o[i],
                      Vcmax25_n = pars_v$k25[i],
                      Vcmax_dS_n = pars_v$dS[i],
                      Vcmax_Hd_n = pars_v$Hd[i],
                      Vcmax_Ea_n = pars_v$Ea[i],
                      Jmax25_m = pars_j$k25_o[i],
                      Jmax_dS_m = pars_j$dS_o[i],
                      Jmax_Hd_m = pars_j$Hd_o[i],
                      Jmax_Ea_m = pars_j$Ea_o[i],
                      Jmax25_n = pars_j$k25[i],
                      Jmax_dS_n = pars_j$dS[i],
                      Jmax_Hd_n = pars_j$Hd[i],
                      Jmax_Ea_n = pars_j$Ea[i])
data_p <- data_p[, 1:6] #Removes temp column to preclude issues later
data_phys[[i]] <- cbind(data_r, data_p)
}

#Model with Medlyn equation
modelled <- list(NULL)
for(i in 1:length(data_phys)){
modelled[[i]] <- calculate_photo(data_phys = data_phys[[i]],
                            data_env = data_env,
                            varnames = list(GammaStar = "GammaStar",
                                            Jmax = "Jmax_medlyn",
                                            Km = "Km",
                                            leaf_respiration = "leaf_respiration",
                                            root_respiration = "root_respiration",
                                            shoot_respiration = "shoot_respiration",
                                            total_respiration_plant = "total_respiration_plant",
                                            Ca = "Ca",
                                            Qin = "Qin",
                                            VPD = "VPD",
                                            Temp = "Temp",
                                            Vcmax = "Vcmax_medlyn"),
                            leaf_area = leaf_area_1,
                            phi = 0.08, #Campbell & Norman 1998
                            time_step = 3600) #3600 s/hr
}

for(i in 1:length(modelled)){
  modelled[[i]][[1]]$ID <- "Medlyn"
}

ge <- list(NULL)
for(i in 1:length(modelled)){
  ge[[i]] <- modelled[[i]][[1]]
}

ge <- do.call("rbind", ge)

dailyC <- list(NULL)
for(i in 1:length(modelled)){
  dailyC[[i]] <- modelled[[i]][[1]] %>% 
    group_by(DOY, Location) %>% 
    summarize(daily_plant_C = sum(A_net_plant * 3600) * 12.01 / 1000000, #12.01 g/mol, umol to mol
              daily_plant_photosynthesis = sum(A_gross_plant * 3600) * 12.01 / 1000000,
              daily_plant_respiration = sum(total_respiration_plant * 3600) * 12.01 / 1000000)
  dailyC[[i]]$ID <- "Medlyn"
}
dailyC <- do.call("rbind", dailyC)

#Model with rederivation
modelled2 <- list(NULL)
for(i in 1:length(data_phys)){
modelled2[[i]] <- calculate_photo(data_phys = data_phys[[i]],
                            data_env = data_env,
                            varnames = list(GammaStar = "GammaStar",
                                            Jmax = "Jmax_new",
                                            Km = "Km",
                                            leaf_respiration = "leaf_respiration",
                                            root_respiration = "root_respiration",
                                            shoot_respiration = "shoot_respiration",
                                            total_respiration_plant = "total_respiration_plant",
                                            Ca = "Ca",
                                            Qin = "Qin",
                                            VPD = "VPD",
                                            Temp = "Temp",
                                            Vcmax = "Vcmax_new"),
                            leaf_area = leaf_area_1,
                            phi = 0.08,
                            time_step = 3600)
}

for(i in 1:length(modelled2)){
  modelled2[[i]][[1]]$ID <- "New"
}

ge2 <- list(NULL)
for(i in 1:length(modelled2)){
  ge2[[i]] <- modelled2[[i]][[1]]
}

ge2 <- do.call("rbind", ge2)

dailyC2 <- list(NULL)
for(i in 1:length(modelled2)){
  dailyC2[[i]] <- modelled2[[i]][[1]] %>% 
    group_by(DOY, Location) %>% 
    summarize(daily_plant_C = sum(A_net_plant * 3600) * 12.01 / 1000000,
              daily_plant_photosynthesis = sum(A_gross_plant * 3600) * 12.01 / 1000000,
              daily_plant_respiration = sum(total_respiration_plant * 3600) * 12.01 / 1000000)
  dailyC2[[i]]$ID <- "Medlyn"
}
dailyC2 <- do.call("rbind", dailyC2)

week_1_carbon <- rbind(dailyC, dailyC2)
week_1_ge <- rbind(ge, ge2)
```

#Week 12 modeling - high root/leaf ratio
```{r}
data <- read.csv(system.file("extdata", "data_test.csv", 
                             package = "arrhenius.comparison"),
                 stringsAsFactors = FALSE)
pars_v <- read.csv(system.file("extdata", "fits_v.csv", 
                             package = "arrhenius.comparison"),
                 stringsAsFactors = FALSE)
pars_j <- read.csv(system.file("extdata", "fits_j.csv", 
                             package = "arrhenius.comparison"),
                 stringsAsFactors = FALSE)
data_phys <- list(NULL)
#Basically, we need a solid set of respiration data
data_r <- calculate_r(data = data,
                      leaf_Q10_day = 2.015,
                      leaf_Q10_night = 2.015,
                      root_Q10 = 2.015,
                      shoot_Q10 = 2.015,
                      leaf_k25_day = 2.78 * 0.7,
                      leaf_k25_night = 2.78,
                      root_k25 = 0.0095,#Weger and Guy 1991
                      shoot_k25 = 0.0095,#Assume stem and root respiration rates are similar
                      leaf_area = leaf_area_12,
                      root_mass = root_mass_12,
                      shoot_mass = stem_mass_12)
data_r <- data_r[, 1:7] #remove temperature column - poses issue later
for(i in 1:nrow(pars_v)){
data_p <- calculate_p(G25 = 42.75,
                      G_Ea = 37.830,
                      Km25 = 718.40,
                      Km_Ea = 65.50828,
                      Temp = data$Temp,
                      Vcmax25_m = pars_v$k25_o[i],
                      Vcmax_dS_m = pars_v$dS_o[i],
                      Vcmax_Hd_m = pars_v$Hd_o[i],
                      Vcmax_Ea_m = pars_v$Ea_o[i],
                      Vcmax25_n = pars_v$k25[i],
                      Vcmax_dS_n = pars_v$dS[i],
                      Vcmax_Hd_n = pars_v$Hd[i],
                      Vcmax_Ea_n = pars_v$Ea[i],
                      Jmax25_m = pars_j$k25_o[i],
                      Jmax_dS_m = pars_j$dS_o[i],
                      Jmax_Hd_m = pars_j$Hd_o[i],
                      Jmax_Ea_m = pars_j$Ea_o[i],
                      Jmax25_n = pars_j$k25[i],
                      Jmax_dS_n = pars_j$dS[i],
                      Jmax_Hd_n = pars_j$Hd[i],
                      Jmax_Ea_n = pars_j$Ea[i])
data_p <- data_p[, 1:6] #Removes temp column to preclude issues later
data_phys[[i]] <- cbind(data_r, data_p)
}

modelled <- list(NULL)
for(i in 1:length(data_phys)){
modelled[[i]] <- calculate_photo(data_phys = data_phys[[i]],
                            data_env = data,
                            varnames = list(GammaStar = "GammaStar",
                                            Jmax = "Jmax_medlyn",
                                            Km = "Km",
                                            leaf_respiration = "leaf_respiration",
                                            root_respiration = "root_respiration",
                                            shoot_respiration = "shoot_respiration",
                                            total_respiration_plant = "total_respiration_plant",
                                            Ca = "Ca",
                                            Qin = "Qin",
                                            VPD = "VPD",
                                            Temp = "Temp",
                                            Vcmax = "Vcmax_medlyn"),
                            leaf_area = leaf_area_12,
                            phi = 0.08,
                            time_step = 3600)
}

#Note, we will need a for loop that looks like this:
for(i in 1:length(modelled)){
  modelled[[i]][[1]]$ID <- "Medlyn"
}

ge <- list(NULL)
for(i in 1:length(modelled)){
  ge[[i]] <- modelled[[i]][[1]]
}

ge <- do.call("rbind", ge)

dailyC <- list(NULL)
for(i in 1:length(modelled)){
  dailyC[[i]] <- modelled[[i]][[1]] %>% 
    group_by(DOY, Location) %>% 
    summarize(daily_plant_C = sum(A_net_plant * 3600) * 12.01 / 1000000,
              daily_plant_photosynthesis = sum(A_gross_plant * 3600) * 12.01 / 1000000,
              daily_plant_respiration = sum(total_respiration_plant * 3600) * 12.01 / 1000000)
  dailyC[[i]]$ID <- "Medlyn"
}
dailyC <- do.call("rbind", dailyC)

modelled2 <- list(NULL)
for(i in 1:length(data_phys)){
modelled2[[i]] <- calculate_photo(data_phys = data_phys[[i]],
                            data_env = data,
                            varnames = list(GammaStar = "GammaStar",
                                            Jmax = "Jmax_new",
                                            Km = "Km",
                                            leaf_respiration = "leaf_respiration",
                                            root_respiration = "root_respiration",
                                            shoot_respiration = "shoot_respiration",
                                            total_respiration_plant = "total_respiration_plant",
                                            Ca = "Ca",
                                            Qin = "Qin",
                                            VPD = "VPD",
                                            Temp = "Temp",
                                            Vcmax = "Vcmax_new"),
                            leaf_area = leaf_area_12,
                            phi = 0.08,
                            time_step = 3600)
}
#Note, we will need a for loop that looks like this:
for(i in 1:length(modelled2)){
  modelled2[[i]][[1]]$ID <- "New"
}

ge2 <- list(NULL)
for(i in 1:length(modelled2)){
  ge2[[i]] <- modelled2[[i]][[1]]
}

ge2 <- do.call("rbind", ge2)

dailyC2 <- list(NULL)
for(i in 1:length(modelled2)){
  dailyC2[[i]] <- modelled2[[i]][[1]] %>% 
    group_by(DOY, Location) %>% 
    summarize(daily_plant_C = sum(A_net_plant * 3600) * 12.01 / 1000000,
              daily_plant_photosynthesis = sum(A_gross_plant * 3600) * 12.01 / 1000000,
              daily_plant_respiration = sum(total_respiration_plant * 3600) * 12.01 / 1000000)
  dailyC2[[i]]$ID <- "Medlyn"
}
dailyC2 <- do.call("rbind", dailyC2)

week_12_carbon <- rbind(dailyC, dailyC2)
week_12_ge <- rbind(ge, ge2)
```

Merge both datasets and output
```{r}
carbon <- rbind(week_1_carbon, week_12_carbon)
gasex <- rbind(week_1_ge, week_12_ge)
write.csv(carbon, "carbon.csv")
write.csv(gasex, "gasex.csv")
```